<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Scanner - Multi-User</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .api-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .api-notice.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-notice button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .scanner-section, .list-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .photo-preview {
            text-align: center;
            margin: 20px 0;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-large {
            font-size: 1.2rem;
            padding: 20px 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .book-list {
            display: grid;
            gap: 15px;
        }

        .book-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .book-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .book-item h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.3rem;
        }

        .book-item p {
            margin-bottom: 5px;
            color: #666;
        }

        .book-item .scanned-by {
            font-size: 0.9rem;
            color: #999;
            font-style: italic;
            margin-top: 10px;
        }

        .status {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: 500;
        }

        .status.processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            text-align: center;
        }

        .stat-item {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 15px;
            flex: 1;
            margin: 0 10px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }

        /* Hide file input */
        #photoUpload {
            display: none;
        }

        .debug-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 0.9rem;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .scanner-section, .list-section {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .stat-item {
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“š Book Scanner</h1>
            <p>Take photos of book covers with your phone</p>
        </div>

        <div class="api-notice" id="apiNotice">
            <strong>ðŸ”‘ Setup Required:</strong> Add your Google Vision API key for high-quality OCR
            <button onclick="bookScanner.promptForApiKey()">Add API Key</button>
            <button onclick="bookScanner.showApiInstructions()">Get Free API Key</button>
        </div>

        <div class="scanner-section">
            <h2>ðŸ“± Scan a Book</h2>
            
            <div class="form-group">
                <label for="scannerName">Your Name:</label>
                <input type="text" id="scannerName" placeholder="Enter your name" />
            </div>

            <div class="controls">
                <input type="file" id="photoUpload" accept="image/*" capture="environment">
                <button id="uploadBtn" class="btn btn-large">ðŸ“· Take/Choose Photo</button>
            </div>

            <div id="photoPreview" class="photo-preview hidden">
                <img id="previewImage" src="" alt="Book cover preview" />
            </div>

            <div id="status" class="status hidden"></div>

            <div id="debugInfo" class="debug-info hidden"></div>

            <div id="extractedData" class="hidden">
                <h3>ðŸ“– Extracted Information</h3>
                <div class="form-group">
                    <label for="bookTitle">Title:</label>
                    <input type="text" id="bookTitle" placeholder="Book title" />
                </div>
                <div class="form-group">
                    <label for="bookAuthor">Author:</label>
                    <input type="text" id="bookAuthor" placeholder="Author name" />
                </div>
                <div class="form-group">
                    <label for="bookPublisher">Publisher:</label>
                    <input type="text" id="bookPublisher" placeholder="Publisher" />
                </div>
                <div class="controls">
                    <button id="addBook" class="btn">âœ… Add to List</button>
                    <button id="scanAnother" class="btn btn-secondary">ðŸ”„ Scan Another</button>
                </div>
            </div>
        </div>

        <div class="list-section">
            <h2>ðŸ“‹ Scanned Books</h2>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalBooks">0</span>
                    <span>Total Books</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="totalScanners">0</span>
                    <span>Contributors</span>
                </div>
            </div>
            <div class="book-list" id="bookList">
                <p style="text-align: center; color: #666; font-style: italic;">No books scanned yet. Start scanning to populate the list!</p>
            </div>
        </div>
    </div>

    <script>
        class BookScanner {
            constructor() {
                this.books = this.loadBooks();
                this.apiKey = localStorage.getItem('googleCloudApiKey') || '';
                this.hasSuccessfulScan = localStorage.getItem('hasSuccessfulScan') === 'true';
                
                this.initEventListeners();
                this.updateDisplay();
                this.updateApiNotice();
                
                // Debug mode - show debug info
                this.debugMode = window.location.search.includes('debug=true');
                if (this.debugMode) {
                    document.getElementById('debugInfo').classList.remove('hidden');
                }
            }

            debug(message) {
                console.log('[BookScanner]', message);
                if (this.debugMode) {
                    const debugDiv = document.getElementById('debugInfo');
                    debugDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
                    debugDiv.scrollTop = debugDiv.scrollHeight;
                }
            }

            updateApiNotice() {
                const notice = document.getElementById('apiNotice');
                if (this.apiKey && this.hasSuccessfulScan) {
                    notice.style.display = 'none';
                } else if (this.apiKey) {
                    notice.innerHTML = '<strong>âœ… Google Vision API:</strong> High-quality OCR enabled!';
                    notice.className = 'api-notice success';
                } else {
                    notice.style.display = 'block';
                }
            }

            promptForApiKey() {
                const key = prompt('Enter your Google Cloud Vision API Key:\n\n(Get one free at console.cloud.google.com - Enable Vision API, then create credentials)');
                if (key && key.trim()) {
                    this.apiKey = key.trim();
                    localStorage.setItem('googleCloudApiKey', this.apiKey);
                    this.updateApiNotice();
                    this.showStatus('âœ… API key saved! You can now use high-quality OCR.', 'success');
                }
            }

            showApiInstructions() {
                const instructions = `
ðŸ“ Get Free Google Vision API Key:

1. Go to: console.cloud.google.com
2. Create a new project (or select existing)
3. Search for "Vision API" and enable it
4. Go to "Credentials" â†’ "Create Credentials" â†’ "API Key"
5. Copy the API key and paste it here

Free tier: 1,000 OCR requests/month
No credit card required!
                `;
                alert(instructions);
                this.promptForApiKey();
            }

            initEventListeners() {
                document.getElementById('uploadBtn').addEventListener('click', () => this.openPhotoUpload());
                document.getElementById('photoUpload').addEventListener('change', (e) => this.handlePhotoUpload(e));
                document.getElementById('addBook').addEventListener('click', () => this.addBook());
                document.getElementById('scanAnother').addEventListener('click', () => this.resetForNewScan());
                
                // Keyboard shortcut for API key
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.shiftKey && e.key === 'K') {
                        e.preventDefault();
                        this.promptForApiKey();
                    }
                });
            }

            openPhotoUpload() {
                this.debug('Opening photo upload dialog');
                document.getElementById('photoUpload').click();
            }

            handlePhotoUpload(event) {
                const file = event.target.files[0];
                if (!file) {
                    this.debug('No file selected');
                    return;
                }

                this.debug(`File selected: ${file.name}, size: ${file.size}, type: ${file.type}`);

                const scannerName = document.getElementById('scannerName').value.trim();
                if (!scannerName) {
                    this.showStatus('Please enter your name before scanning.', 'error');
                    return;
                }

                // Show photo preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.debug('Image loaded, showing preview');
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('photoPreview').classList.remove('hidden');
                    
                    // Start processing
                    this.processImage(e.target.result);
                };
                reader.onerror = (e) => {
                    this.debug('Error reading file: ' + e);
                    this.showStatus('Error reading image file', 'error');
                };
                reader.readAsDataURL(file);
            }

            async processImage(imageData) {
                this.debug('Starting image processing');
                try {
                    let text = '';
                    
                    if (this.apiKey) {
                        this.showStatus('ðŸ” Processing with Google Vision API...', 'processing');
                        this.debug('Using Google Vision API');
                        text = await this.callGoogleVisionAPI(imageData);
                        this.debug(`Extracted text length: ${text.length}`);
                    } else {
                        this.showStatus('ðŸ” Processing with basic OCR (lower quality)...', 'processing');
                        this.debug('Using Tesseract fallback');
                        text = await this.processWithTesseract(imageData);
                        this.debug(`Extracted text length: ${text.length}`);
                    }
                    
                    this.debug('Raw extracted text: ' + text.substring(0, 200) + '...');
                    
                    const bookData = this.extractBookInfo(text);
                    this.debug(`Extracted book data: ${JSON.stringify(bookData)}`);
                    
                    this.showExtractedData(bookData);
                    this.showStatus('âœ… Text extraction complete! Please review the information below.', 'success');
                    
                    // Mark as successful and hide banner
                    this.hasSuccessfulScan = true;
                    localStorage.setItem('hasSuccessfulScan', 'true');
                    this.updateApiNotice();
                    
                } catch (error) {
                    this.debug('Error processing image: ' + error.message);
                    console.error('OCR Error:', error);
                    this.showStatus('âŒ Error processing image: ' + error.message, 'error');
                    this.resetForNewScan();
                }
            }

            async callGoogleVisionAPI(imageData) {
                this.debug('Calling Google Vision API');
                const base64Image = imageData.split(',')[1];
                
                const requestBody = {
                    requests: [{
                        image: { content: base64Image },
                        features: [{ type: 'TEXT_DETECTION', maxResults: 1 }]
                    }]
                };

                this.debug('Sending request to Google Vision API');
                const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${this.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                this.debug(`API response status: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    this.debug(`API error response: ${errorText}`);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                this.debug('API response received');
                
                if (result.responses?.[0]?.error) {
                    throw new Error(`Vision API Error: ${result.responses[0].error.message}`);
                }
                
                if (result.responses?.[0]?.textAnnotations?.[0]) {
                    return result.responses[0].textAnnotations[0].description;
                } else {
                    throw new Error('No text detected in image');
                }
            }

            async processWithTesseract(imageData) {
                this.debug('Loading Tesseract');
                // Load Tesseract dynamically
                if (!window.Tesseract) {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js';
                    document.head.appendChild(script);
                    
                    await new Promise(resolve => {
                        script.onload = resolve;
                    });
                }

                this.debug('Running Tesseract OCR');
                const { data: { text } } = await Tesseract.recognize(imageData, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            this.showStatus(`ðŸ” Processing with basic OCR... ${progress}%`, 'processing');
                        }
                    }
                });
                
                return text;
            }

            extractBookInfo(text) {
                this.debug('Extracting book information from text');
                const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 2);
                
                let title = '';
                let author = '';
                let publisher = '';
                
                // Enhanced extraction logic
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Skip lines that are clearly not book info
                    if (line.length < 3 || /^[^a-zA-Z0-9\s]/.test(line)) continue;
                    
                    // Find author patterns
                    if (!author && (/\b(by|author|written by)\b/i.test(line) || 
                        /^[A-Z][a-z]+ [A-Z][a-z]+$/.test(line))) {
                        author = line.replace(/\b(by|author|written by)\b/gi, '').trim();
                        continue;
                    }
                    
                    // Find publisher patterns
                    if (/\b(press|books|publishing|publishers?|publications?|media|house)\b/i.test(line)) {
                        publisher = line;
                        continue;
                    }
                    
                    // Title is usually the longest meaningful line that's not author/publisher
                    if (!title && line.length > 5 && line.length < 100 && 
                        !/\b(isbn|copyright|edition|page|chapter)\b/i.test(line)) {
                        title = line;
                    }
                }
                
                // Fallbacks
                if (!title && lines.length > 0) title = lines[0];
                if (!author && lines.length > 1) author = lines[1];
                if (!publisher && lines.length > 2) publisher = lines[lines.length - 1];
                
                return { 
                    title: title || 'Unknown Title', 
                    author: author || 'Unknown Author', 
                    publisher: publisher || 'Unknown Publisher' 
                };
            }

            showExtractedData(bookData) {
                this.debug('Showing extracted data form');
                document.getElementById('bookTitle').value = bookData.title;
                document.getElementById('bookAuthor').value = bookData.author;
                document.getElementById('bookPublisher').value = bookData.publisher;
                document.getElementById('extractedData').classList.remove('hidden');
            }

            addBook() {
                const scannerName = document.getElementById('scannerName').value.trim();
                const title = document.getElementById('bookTitle').value.trim();
                const author = document.getElementById('bookAuthor').value.trim();
                const publisher = document.getElementById('bookPublisher').value.trim();
                
                if (!title) {
                    this.showStatus('Please enter at least a book title.', 'error');
                    return;
                }
                
                const book = {
                    id: Date.now(),
                    title,
                    author: author || 'Unknown Author',
                    publisher: publisher || 'Unknown Publisher',
                    scannedBy: scannerName,
                    timestamp: new Date().toLocaleString()
                };
                
                this.debug(`Adding book: ${JSON.stringify(book)}`);
                this.books.unshift(book);
                this.saveBooks();
                this.updateDisplay();
                this.showStatus(`âœ… "${title}" added to the list!`, 'success');
                this.resetForNewScan();
            }

            resetForNewScan() {
                this.debug('Resetting for new scan');
                document.getElementById('extractedData').classList.add('hidden');
                document.getElementById('photoPreview').classList.add('hidden');
                document.getElementById('bookTitle').value = '';
                document.getElementById('bookAuthor').value = '';
                document.getElementById('bookPublisher').value = '';
                document.getElementById('status').classList.add('hidden');
                document.getElementById('photoUpload').value = '';
            }

            updateDisplay() {
                this.debug(`Updating display with ${this.books.length} books`);
                const bookList = document.getElementById('bookList');
                const totalBooks = document.getElementById('totalBooks');
                const totalScanners = document.getElementById('totalScanners');
                
                totalBooks.textContent = this.books.length;
                
                const uniqueScanners = new Set(this.books.map(book => book.scannedBy));
                totalScanners.textContent = uniqueScanners.size;
                
                if (this.books.length === 0) {
                    bookList.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No books scanned yet. Start scanning to populate the list!</p>';
                } else {
                    bookList.innerHTML = this.books.map(book => `
                        <div class="book-item">
                            <h3>${this.escapeHtml(book.title)}</h3>
                            <p><strong>Author:</strong> ${this.escapeHtml(book.author)}</p>
                            <p><strong>Publisher:</strong> ${this.escapeHtml(book.publisher)}</p>
                            <p class="scanned-by">Scanned by ${this.escapeHtml(book.scannedBy)} on ${book.timestamp}</p>
                        </div>
                    `).join('');
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showStatus(message, type) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${type}`;
                status.classList.remove('hidden');
                
                if (type === 'success') {
                    setTimeout(() => status.classList.add('hidden'), 3000);
                }
            }

            loadBooks() {
                try {
                    const books = JSON.parse(localStorage.getItem('scannedBooks') || '[]');
                    this.debug(`Loaded ${books.length} books from storage`);
                    return books;
                } catch {
                    return [];
                }
            }

            saveBooks() {
                localStorage.setItem('scannedBooks', JSON.stringify(this.books));
                this.debug(`Saved ${this.books.length} books to storage`);
            }
        }

        // Initialize the app
        const bookScanner = new BookScanner();

        // Enable debug mode by adding ?debug=true to URL
        if (window.location.search.includes('debug=true')) {
            console.log('Debug mode enabled - check the debug info section');
        }
    </script>
</body>
</html>

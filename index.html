<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Scanner Test</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 { 
            text-align: center;
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .btn { 
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 50px; 
            margin: 10px 5px;
            cursor: pointer; 
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.6);
        }
        
        .btn-large {
            font-size: 1.2rem;
            padding: 20px 40px;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.6);
        }
        
        .form-group { 
            margin: 15px 0; 
        }
        
        .form-group label { 
            display: block; 
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input { 
            padding: 15px; 
            width: 100%; 
            border: 2px solid #e9ecef; 
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 10px;
            font-weight: 500;
            text-align: center;
        }
        
        .success { 
            background: #d4edda; 
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error { 
            background: #f8d7da; 
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .book-item { 
            background: white;
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 15px;
            border-left: 5px solid #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .book-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .book-item h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .book-item p {
            margin-bottom: 5px;
            color: #666;
        }
        
        .book-item em {
            color: #999;
            font-size: 0.9rem;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        #photoUpload {
            display: none;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .btn {
                display: block;
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Book Scanner</h1>
        <p class="subtitle">Take photos of book covers with your phone</p>
        
        <div class="section">
            <h2>Scanner Info</h2>
            
            <div class="form-group">
                <label for="scannerName">Your Name:</label>
                <input type="text" id="scannerName" placeholder="Enter your name" />
            </div>
            
            <div class="form-group">
                <label for="defaultTeacher">Teacher:</label>
                <input type="text" id="defaultTeacher" placeholder="Enter teacher name" />
            </div>
            
            <div class="controls">
                <button class="btn" onclick="saveInfo()">Save My Info</button>
                <button class="btn" onclick="clearInfo()">Clear Saved Info</button>
            </div>
            
            <!-- Info status messages will appear here -->
            <div id="infoStatus"></div>
        </div>

        <div class="section" id="scanSection">
            <h2>Scan a Book</h2>
            <div class="controls">
                <button class="btn btn-large" onclick="takePhoto()">Take/Choose Photo</button>
            </div>
        </div>

        <!-- General status messages will appear here -->
        <div id="status"></div>

        <input type="file" id="photoUpload" accept="image/*" capture="environment" onchange="handleFile(this)">

        <div id="extractedData" style="display: none;" class="section">
            <h2>Book Information</h2>
            <div class="form-group">
                <label for="bookTitle">Title:</label>
                <input type="text" id="bookTitle" placeholder="Book title" />
            </div>
            <div class="form-group">
                <label for="bookAuthor">Author:</label>
                <input type="text" id="bookAuthor" placeholder="Author name" />
            </div>
            <div class="form-group">
                <label for="bookPublisher">Publisher:</label>
                <input type="text" id="bookPublisher" placeholder="Publisher" />
            </div>
            <div class="controls">
                <button class="btn" onclick="addBook()">Add Book</button>
            </div>
        </div>

        <div class="section">
            <h2>Books List</h2>
            <div class="controls" id="addNewBookControls" style="display: none;">
                <button class="btn btn-secondary" onclick="addNewBook()">Add New Book</button>
            </div>
            <div id="booksList"></div>
        </div>
    </div>

    <script>
        console.log('Script loading...');
        
        let books = [];
        const API_KEY = 'AIzaSyA05Qc5KbXVQMwkAVBACaSIvUBWcChcXwE'; // Replace with your actual Google Vision API key
        
        function showStatus(message, type, targetElement = 'status') {
            console.log('Status:', message);
            const status = document.getElementById(targetElement);
            status.innerHTML = '<div class="status ' + type + '">' + message + '</div>';
            setTimeout(() => status.innerHTML = '', 3000);
        }
        
        function saveInfo() {
            console.log('Save button clicked');
            const name = document.getElementById('scannerName').value.trim();
            const teacher = document.getElementById('defaultTeacher').value.trim();
            
            if (!name || !teacher) {
                showStatus('Please enter both name and teacher', 'error', 'infoStatus');
                return;
            }
            
            localStorage.setItem('scannerName', name);
            localStorage.setItem('defaultTeacher', teacher);
            showStatus('Info saved successfully!', 'success', 'infoStatus');
        }
        
        function clearInfo() {
            console.log('Clear button clicked');
            localStorage.removeItem('scannerName');
            localStorage.removeItem('defaultTeacher');
            document.getElementById('scannerName').value = '';
            document.getElementById('defaultTeacher').value = '';
            showStatus('Info cleared!', 'success', 'infoStatus');
        }
        
        function takePhoto() {
            console.log('Photo button clicked');
            const scannerName = document.getElementById('scannerName').value.trim();
            const teacherName = document.getElementById('defaultTeacher').value.trim();
            
            if (!scannerName || !teacherName) {
                showStatus('Please save your info first', 'error');
                return;
            }
            
            document.getElementById('photoUpload').click();
        }
        
        function addNewBook() {
            console.log('Add New Book clicked');
            
            // Reset the photo upload
            document.getElementById('photoUpload').value = '';
            
            // Hide extracted data section
            document.getElementById('extractedData').style.display = 'none';
            
            // Clear any status messages
            document.getElementById('status').innerHTML = '';
            
            // Clear form fields
            document.getElementById('bookTitle').value = '';
            document.getElementById('bookAuthor').value = '';
            document.getElementById('bookPublisher').value = '';
            
            // Show success message
            showStatus('Ready to scan a new book!', 'success');
            
            // Scroll to scan section
            document.getElementById('scanSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        async function handleFile(input) {
            console.log('File selected');
            const file = input.files[0];
            if (!file) return;
            
            showStatus('Processing image with Google Vision API...', 'success');
            
            try {
                // Convert file to base64
                const base64Image = await fileToBase64(file);
                
                if (API_KEY && API_KEY !== 'YOUR_API_KEY_HERE') {
                    // Use Google Vision API
                    const extractedText = await callGoogleVisionAPI(base64Image);
                    const bookData = extractBookInfo(extractedText);
                    
                    // Populate the form with extracted data
                    document.getElementById('bookTitle').value = bookData.title;
                    document.getElementById('bookAuthor').value = bookData.author;
                    document.getElementById('bookPublisher').value = bookData.publisher;
                    
                    showStatus('Text extracted! Please review and correct the information below.', 'success');
                } else {
                    showStatus('Manual mode: Please type book information', 'success');
                }
                
                document.getElementById('extractedData').style.display = 'block';
                
            } catch (error) {
                console.error('OCR Error:', error);
                showStatus('OCR failed, using manual mode', 'error');
                document.getElementById('extractedData').style.display = 'block';
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        async function callGoogleVisionAPI(imageData) {
            console.log('Starting Google Vision API call...');
            const base64Image = imageData.split(',')[1];
            
            const requestBody = {
                requests: [{
                    image: { content: base64Image },
                    features: [{ type: 'TEXT_DETECTION', maxResults: 1 }]
                }]
            };

            console.log('Sending request to Vision API...');
            const response = await fetch('https://vision.googleapis.com/v1/images:annotate?key=' + API_KEY, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            console.log('API Response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error Response:', errorText);
                throw new Error('API Error: ' + response.status + ' - ' + errorText);
            }

            const result = await response.json();
            console.log('API Response received:', result);
            
            if (result.responses && result.responses[0] && result.responses[0].error) {
                console.error('Vision API Error:', result.responses[0].error);
                throw new Error('Vision API Error: ' + result.responses[0].error.message);
            }
            
            if (result.responses && result.responses[0] && result.responses[0].textAnnotations && result.responses[0].textAnnotations[0]) {
                console.log('Text extracted successfully, length:', result.responses[0].textAnnotations[0].description.length);
                return result.responses[0].textAnnotations[0].description;
            } else {
                console.warn('No text detected in image');
                throw new Error('No text detected in image');
            }
        }
        
        function extractBookInfo(text) {
            console.log('Extracting book info from:', text.substring(0, 200) + '...');
            
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 2);
            
            let title = '';
            let author = '';
            let publisher = '';
            
            // Look for title and author patterns
            const titleCandidates = [];
            const authorCandidates = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Skip very short lines or lines with mostly symbols
                if (line.length < 3 || /^[^a-zA-Z0-9\s]+$/.test(line)) continue;
                
                // AUTHOR DETECTION - Look for clear author patterns first
                if (/^(written by|by|author|story by|text by)\s+/i.test(line)) {
                    const authorName = line.replace(/^(written by|by|author|story by|text by)\s+/i, '').trim();
                    if (authorName && authorName.length > 2) {
                        authorCandidates.push(authorName);
                        continue;
                    }
                }
                
                // Author in "words and pictures by [name]" format
                if (/words and pictures by\s+(.+)$/i.test(line)) {
                    const match = line.match(/words and pictures by\s+(.+)$/i);
                    if (match && match[1]) {
                        authorCandidates.push(match[1].trim());
                        continue;
                    }
                }
                
                // PUBLISHER DETECTION
                if (/\b(press|books|publishing|publishers?|publications?|media|house)\b/i.test(line) && 
                    !/^(the|a|an)\s/i.test(line)) {
                    publisher = line;
                    continue;
                }
                
                // TITLE DETECTION - Skip obvious non-titles
                if (
                    // Skip series/bestseller info
                    /(bestselling|series|#\d+|new york times)/i.test(line) ||
                    // Skip author credit lines
                    /(written by|by|author|illustrated by|words and pictures)/i.test(line) ||
                    // Skip speech bubbles and short phrases
                    /(come on!?|go to)/i.test(line) ||
                    // Skip ISBN, copyright, etc.
                    /(isbn|copyright|edition|page|chapter)/i.test(line) ||
                    // Skip very long lines (likely descriptions)
                    line.length > 80 ||
                    // Skip very short lines (likely fragments)
                    line.length < 5
                ) {
                    continue;
                }
                
                // Good title candidate - meaningful length, looks like a title
                if (line.length >= 5 && line.length <= 60) {
                    // Prioritize lines with title-case or all caps (common for titles)
                    let priority = 0;
                    
                    // Higher priority for all caps (like "THE SMART COOKIE")
                    if (/^[A-Z\s\-!]+$/.test(line)) {
                        priority += 10;
                    }
                    
                    // Higher priority for title case
                    if (/^[A-Z][a-z]+(\s[A-Z][a-z]*)*/.test(line)) {
                        priority += 5;
                    }
                    
                    // Higher priority for lines with common title words
                    if (/\b(the|a|an|and|or|to|has|goes|will|can)\b/i.test(line)) {
                        priority += 3;
                    }
                    
                    // Higher priority for longer meaningful titles
                    if (line.split(' ').length >= 3) {
                        priority += 2;
                    }
                    
                    titleCandidates.push({ text: line, priority: priority });
                }
            }
            
            // Select best title candidate
            if (titleCandidates.length > 0) {
                // Sort by priority (highest first)
                titleCandidates.sort((a, b) => b.priority - a.priority);
                title = titleCandidates[0].text;
            }
            
            // Select best author candidate
            if (authorCandidates.length > 0) {
                // Prefer the first clear author match
                author = authorCandidates[0];
            }
            
            // Fallback: if no title found, try to construct from multiple lines
            if (!title && lines.length > 0) {
                // Look for the most prominent text that isn't author info
                const filteredLines = lines.filter(line => 
                    !/(written by|by|author|words and pictures|bestselling|series)/i.test(line) &&
                    line.length >= 10 && line.length <= 60
                );
                
                if (filteredLines.length > 0) {
                    title = filteredLines[0];
                }
            }
            
            // If we still don't have an author, look for standalone name patterns
            if (!author) {
                for (const line of lines) {
                    // Look for proper names (First Last, or First Middle Last)
                    if (/^[A-Z][a-z]+\s+[A-Z][a-z]+(\s+[A-Z][a-z]+)?$/.test(line) && 
                        !/(the|pigeon|cookie|smart)/i.test(line)) {
                        author = line;
                        break;
                    }
                }
            }
            
            console.log('Extracted:', { title, author, publisher });
            
            return { 
                title: title || '', 
                author: author || '', 
                publisher: publisher || '' 
            };
        }
        
        function addBook() {
            console.log('Add book clicked');
            const title = document.getElementById('bookTitle').value.trim();
            const author = document.getElementById('bookAuthor').value.trim();
            const publisher = document.getElementById('bookPublisher').value.trim();
            const scannedBy = document.getElementById('scannerName').value.trim();
            const teacher = document.getElementById('defaultTeacher').value.trim();
            
            if (!title || !author) {
                showStatus('Please enter at least title and author', 'error');
                return;
            }
            
            const book = {
                id: Date.now(),
                title,
                author,
                publisher: publisher || 'Not specified',
                scannedBy,
                teacher,
                timestamp: new Date().toLocaleString()
            };
            
            books.unshift(book);
            updateBooksList();
            submitToGoogleSheets(book);
            
            // Reset form
            document.getElementById('bookTitle').value = '';
            document.getElementById('bookAuthor').value = '';
            document.getElementById('bookPublisher').value = '';
            document.getElementById('extractedData').style.display = 'none';
            
            // Show the "Add New Book" button
            document.getElementById('addNewBookControls').style.display = 'block';
            
            showStatus('Book "' + title + '" added!', 'success');
        }
        
        function updateBooksList() {
            const booksList = document.getElementById('booksList');
            booksList.innerHTML = books.map(book => 
                '<div class="book-item">' +
                '<h3>' + book.title + '</h3>' +
                '<p><strong>Author:</strong> ' + book.author + '</p>' +
                '<p><strong>Publisher:</strong> ' + book.publisher + '</p>' +
                '<p><strong>Teacher:</strong> ' + book.teacher + '</p>' +
                '<p><em>Scanned by ' + book.scannedBy + ' on ' + book.timestamp + '</em></p>' +
                '</div>'
            ).join('');
        }
        
        async function submitToGoogleSheets(book) {
            try {
                console.log('Submitting to Google Sheets:', book);
                const formData = new FormData();
                formData.append('entry.751697957', book.title);
                formData.append('entry.654337640', book.author);
                formData.append('entry.1879822333', book.publisher);
                formData.append('entry.320463454', book.scannedBy);
                formData.append('entry.76820609', book.teacher);
                
                const response = await fetch('https://docs.google.com/forms/d/e/1FAIpQLScqbEx1MYyVhgYDq29SDNQiyY1F3MlF-3nbfBT950qRG5amVg/formResponse', {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors'
                });
                
                console.log('Google Sheets submission complete');
            } catch (error) {
                console.error('Google Sheets error:', error);
            }
        }
        
        // Load saved info on startup
        window.onload = function() {
            console.log('Page loaded');
            const savedName = localStorage.getItem('scannerName');
            const savedTeacher = localStorage.getItem('defaultTeacher');
            
            if (savedName) document.getElementById('scannerName').value = savedName;
            if (savedTeacher) document.getElementById('defaultTeacher').value = savedTeacher;
            
            if (savedName && savedTeacher) {
                showStatus('Welcome back, ' + savedName + '!', 'success', 'infoStatus');
            }
        };
        
        console.log('Script loaded successfully');
    </script>
</body>
</html>

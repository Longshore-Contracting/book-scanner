<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Scanner - Multi-User</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .api-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .api-notice.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-notice button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .scanner-section, .list-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .photo-preview {
            text-align: center;
            margin: 20px 0;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-large {
            font-size: 1.2rem;
            padding: 20px 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .book-list {
            display: grid;
            gap: 15px;
        }

        .book-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .book-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .book-item h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.3rem;
        }

        .book-item p {
            margin-bottom: 5px;
            color: #666;
        }

        .book-item .scanned-by {
            font-size: 0.9rem;
            color: #999;
            font-style: italic;
            margin-top: 10px;
        }

        .status {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: 500;
        }

        .status.processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            text-align: center;
        }

        .stat-item {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 15px;
            flex: 1;
            margin: 0 10px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }

        #photoUpload {
            display: none;
        }

        .debug-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 0.9rem;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
        }

        .info-saved {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .scanner-section, .list-section {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .stat-item {
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Book Scanner</h1>
            <p>Take photos of book covers with your phone</p>
        </div>

        <div class="api-notice" id="apiNotice" style="display: none;">
            <!-- Banner hidden when hardcoded -->
        </div>

        <div class="scanner-section">
            <h2>üë§ Scanner Info</h2>
            
            <div class="form-group">
                <label for="scannerName">Your Name:</label>
                <input type="text" id="scannerName" placeholder="Enter your name" />
            </div>
            
            <div class="form-group">
                <label for="defaultTeacher">Teacher:</label>
                <input type="text" id="defaultTeacher" placeholder="Enter teacher name" />
            </div>
            
            <div class="controls">
                <button id="saveUserInfo" class="btn">üíæ Save My Info</button>
                <button id="clearUserInfo" class="btn btn-secondary">üóëÔ∏è Clear Saved Info</button>
            </div>
            
            <hr style="margin: 30px 0; border: none; border-top: 2px solid #e9ecef;">
            
            <h2>üì± Scan a Book</h2>

            <div class="controls">
                <input type="file" id="photoUpload" accept="image/*" capture="environment">
                <button id="uploadBtn" class="btn btn-large">üì∑ Take/Choose Photo</button>
            </div>

            <div id="photoPreview" class="photo-preview hidden">
                <img id="previewImage" src="" alt="Book cover preview" />
            </div>

            <div id="status" class="status hidden"></div>

            <div id="debugInfo" class="debug-info hidden"></div>

            <div id="extractedData" class="hidden">
                <h3>üìñ Extracted Information</h3>
                <div class="form-group">
                    <label for="bookTitle">Title:</label>
                    <input type="text" id="bookTitle" placeholder="Book title" />
                </div>
                <div class="form-group">
                    <label for="bookAuthor">Author:</label>
                    <input type="text" id="bookAuthor" placeholder="Author name" />
                </div>
                <div class="form-group">
                    <label for="bookPublisher">Publisher (optional):</label>
                    <input type="text" id="bookPublisher" placeholder="Publisher" />
                </div>
                <div class="form-group">
                    <label for="bookTeacher">Teacher:</label>
                    <input type="text" id="bookTeacher" placeholder="Teacher name" readonly style="background-color: #f8f9fa;" />
                    <small style="color: #666; font-size: 0.9rem;">Auto-filled from scanner info above</small>
                </div>
                <div class="controls">
                    <button id="addBook" class="btn">‚úÖ Add to List</button>
                    <button id="scanAnother" class="btn btn-secondary">üîÑ Scan Another</button>
                </div>
            </div>
        </div>

        <div class="list-section">
            <h2>üìã Scanned Books</h2>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalBooks">0</span>
                    <span>Total Books</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="totalScanners">0</span>
                    <span>Contributors</span>
                </div>
            </div>
            <div class="book-list" id="bookList">
                <p style="text-align: center; color: #666; font-style: italic;">No books scanned yet. Start scanning to populate the list!</p>
            </div>
        </div>
    </div>

    <script>
        class BookScanner {
            constructor() {
                this.books = this.loadBooks();
                
                // HARDCODED VALUES - Replace with your actual values
                this.apiKey = 'AIzaSyA05Qc5KbXVQMwkAVBACaSIvUBWcChcXwE'; // Replace with your API key
                this.googleFormUrl = 'https://docs.google.com/forms/d/e/1FAIpQLScqbEx1MYyVhgYDq29SDNQiyY1F3MlF-3nbfBT950qRG5amVg/formResponse'; // Your form submit URL
                
                // Check if API key is still placeholder
                if (this.apiKey === 'YOUR_GOOGLE_VISION_API_KEY_HERE') {
                    this.manualMode = true;
                    this.showStatus('‚ö†Ô∏è API key not configured. Using manual mode.', 'error');
                } else {
                    this.manualMode = false;
                }
                
                this.hasSuccessfulScan = localStorage.getItem('hasSuccessfulScan') === 'true';
                
                // Load saved user info
                this.loadUserInfo();
                
                this.initEventListeners();
                this.updateDisplay();
                this.updateApiNotice();
                
                this.debugMode = window.location.search.includes('debug=true');
                if (this.debugMode) {
                    document.getElementById('debugInfo').classList.remove('hidden');
                }
            }

            loadUserInfo() {
                const savedName = localStorage.getItem('scannerName');
                const savedTeacher = localStorage.getItem('defaultTeacher');
                
                if (savedName) {
                    document.getElementById('scannerName').value = savedName;
                    this.debug(`Loaded saved name: ${savedName}`);
                }
                
                if (savedTeacher) {
                    document.getElementById('defaultTeacher').value = savedTeacher;
                    this.debug(`Loaded saved teacher: ${savedTeacher}`);
                }
                
                // Show welcome message if both are saved
                if (savedName && savedTeacher) {
                    this.showStatus(`üëã Welcome back, ${savedName}! Ready to scan books for ${savedTeacher}.`, 'success');
                }
            }

            saveUserInfo() {
                const name = document.getElementById('scannerName').value.trim();
                const teacher = document.getElementById('defaultTeacher').value.trim();
                
                if (!name || !teacher) {
                    this.showStatus('Please enter both your name and teacher name before saving.', 'error');
                    return;
                }
                
                localStorage.setItem('scannerName', name);
                localStorage.setItem('defaultTeacher', teacher);
                
                this.showStatus(`‚úÖ Saved! ${name} scanning for ${teacher}. This info will be remembered on this device.`, 'success');
                this.debug(`Saved user info: ${name} / ${teacher}`);
            }

            clearUserInfo() {
                localStorage.removeItem('scannerName');
                localStorage.removeItem('defaultTeacher');
                document.getElementById('scannerName').value = '';
                document.getElementById('defaultTeacher').value = '';
                document.getElementById('bookTeacher').value = '';
                
                this.showStatus('üóëÔ∏è Saved info cleared. Enter your details above.', 'success');
                this.debug('Cleared saved user info');
            }

            debug(message) {
                console.log('[BookScanner]', message);
                if (this.debugMode) {
                    const debugDiv = document.getElementById('debugInfo');
                    debugDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
                    debugDiv.scrollTop = debugDiv.scrollHeight;
                }
            }

            updateApiNotice() {
                // When hardcoded, always hide the setup banner
                const notice = document.getElementById('apiNotice');
                notice.style.display = 'none';
            }

            setupGoogleForm() {
                const instructions = `
üìä Connect to Google Sheets:

Your form URL: https://docs.google.com/forms/d/e/1FAIpQLScqbEx1MYyVhgYDq29SDNQiyY1F3MlF-3nbfBT950qRG5amVg/viewform

To get the submit URL:
1. Right-click on your form ‚Üí "View page source"
2. Search for "action" (Ctrl+F)
3. Copy the URL that looks like:
   https://docs.google.com/forms/d/e/1FAIpQLScqbEx1MYyVhgYDq29SDNQiyY1F3MlF-3nbfBT950qRG5amVg/formResponse

OR just paste this (I'll convert it):
                `;
                
                const url = prompt(instructions);
                if (url) {
                    let formUrl = url;
                    
                    if (url.includes('viewform')) {
                        formUrl = url.replace('viewform', 'formResponse').split('?')[0];
                    }
                    
                    if (formUrl.includes('formResponse')) {
                        this.googleFormUrl = formUrl;
                        localStorage.setItem('googleFormUrl', formUrl);
                        this.updateApiNotice();
                        this.showStatus('‚úÖ Google Sheets connected! All new scans will sync to your spreadsheet.', 'success');
                        
                        setTimeout(() => {
                            alert('Next: I need to get the field IDs from your form. Please scan a test book to set this up automatically.');
                        }, 2000);
                    } else {
                        alert('Please paste your Google Form URL (the one that contains your form ID)');
                    }
                }
            }

            promptForApiKey() {
                const key = prompt('Enter your Google Cloud Vision API Key:\n\n(Get one free at console.cloud.google.com - Enable Vision API, then create credentials)');
                if (key && key.trim()) {
                    this.apiKey = key.trim();
                    localStorage.setItem('googleCloudApiKey', this.apiKey);
                    this.updateApiNotice();
                    this.showStatus('‚úÖ API key saved! You can now use high-quality OCR.', 'success');
                }
            }

            showApiInstructions() {
                const instructions = `
üìù Get Free Google Vision API Key:

1. Go to: console.cloud.google.com
2. Create a new project (or select existing)
3. Search for "Vision API" and enable it
4. Go to "Credentials" ‚Üí "Create Credentials" ‚Üí "API Key"
5. Copy the API key and paste it here

Free tier: 1,000 OCR requests/month
No credit card required!
                `;
                alert(instructions);
                this.promptForApiKey();
            }

            toggleManualMode() {
                this.manualMode = true;
                localStorage.setItem('manualMode', 'true');
                this.updateApiNotice();
                this.showStatus('‚úÖ Manual mode enabled! Take photos and type book info yourself.', 'success');
            }

            initEventListeners() {
                document.getElementById('uploadBtn').addEventListener('click', () => this.openPhotoUpload());
                document.getElementById('photoUpload').addEventListener('change', (e) => this.handlePhotoUpload(e));
                document.getElementById('addBook').addEventListener('click', () => this.addBook());
                document.getElementById('scanAnother').addEventListener('click', () => this.resetForNewScan());
                document.getElementById('saveUserInfo').addEventListener('click', () => this.saveUserInfo());
                document.getElementById('clearUserInfo').addEventListener('click', () => this.clearUserInfo());
                
                // Auto-update teacher field when default teacher changes
                document.getElementById('defaultTeacher').addEventListener('input', (e) => {
                    document.getElementById('bookTeacher').value = e.target.value;
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.shiftKey && e.key === 'K') {
                        e.preventDefault();
                        this.promptForApiKey();
                    }
                });
            }

            openPhotoUpload() {
                this.debug('Opening photo upload dialog');
                document.getElementById('photoUpload').click();
            }

            handlePhotoUpload(event) {
                const file = event.target.files[0];
                if (!file) {
                    this.debug('No file selected');
                    return;
                }

                this.debug(`File selected: ${file.name}, size: ${file.size}, type: ${file.type}`);

                // Check if user info is filled
                const scannerName = document.getElementById('scannerName').value.trim();
                const teacherName = document.getElementById('defaultTeacher').value.trim();
                
                if (!scannerName || !teacherName) {
                    this.showStatus('‚ö†Ô∏è Please enter your name and teacher name at the top before scanning books.', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.debug('Image loaded, showing preview');
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('photoPreview').classList.remove('hidden');
                    
                    this.processImage(e.target.result);
                };
                reader.onerror = (e) => {
                    this.debug('Error reading file: ' + e);
                    this.showStatus('Error reading image file', 'error');
                };
                reader.readAsDataURL(file);
            }

            async processImage(imageData) {
                this.debug('Starting image processing');
                try {
                    let text = '';
                    
                    if (this.manualMode) {
                        this.debug('Manual mode - skipping OCR');
                        this.showExtractedData({
                            title: '',
                            author: '',
                            publisher: ''
                        });
                        this.showStatus('üìù Manual mode: Please type the book information below.', 'success');
                        return;
                    }
                    
                    if (this.apiKey) {
                        this.showStatus('üîç Processing with Google Vision API...', 'processing');
                        this.debug('Using Google Vision API');
                        text = await this.callGoogleVisionAPI(imageData);
                        this.debug(`Extracted text length: ${text.length}`);
                    } else {
                        this.showStatus('üîç Processing with basic OCR (lower quality)...', 'processing');
                        this.debug('Using Tesseract fallback');
                        text = await this.processWithTesseract(imageData);
                        this.debug(`Extracted text length: ${text.length}`);
                    }
                    
                    this.debug('Raw extracted text: ' + text.substring(0, 200) + '...');
                    
                    const bookData = this.extractBookInfo(text);
                    this.debug(`Extracted book data: ${JSON.stringify(bookData)}`);
                    
                    this.showExtractedData(bookData);
                    this.showStatus('‚úÖ Text extraction complete! Please review the information below.', 'success');
                    
                    this.hasSuccessfulScan = true;
                    localStorage.setItem('hasSuccessfulScan', 'true');
                    this.updateApiNotice();
                    
                } catch (error) {
                    this.debug('Error processing image: ' + error.message);
                    console.error('OCR Error:', error);
                    
                    if (error.message.includes('400') || error.message.includes('API key')) {
                        this.showStatus('‚ö†Ô∏è Invalid API key. Switching to manual mode...', 'error');
                        setTimeout(() => {
                            this.manualMode = true;
                            this.showExtractedData({
                                title: '',
                                author: '',
                                publisher: ''
                            });
                            this.showStatus('üìù Manual mode: Please type the book information below.', 'success');
                        }, 2000);
                    } else if (error.message.includes('403') || error.message.includes('billing')) {
                        this.showStatus('‚ö†Ô∏è Google API requires billing setup. Switching to manual mode...', 'error');
                        setTimeout(() => {
                            this.manualMode = true;
                            this.showExtractedData({
                                title: '',
                                author: '',
                                publisher: ''
                            });
                            this.showStatus('üìù Manual mode: Please type the book information below.', 'success');
                        }, 2000);
                    } else {
                        this.showStatus('‚ùå Error processing image: ' + error.message, 'error');
                        this.resetForNewScan();
                    }
                }
            }

            async callGoogleVisionAPI(imageData) {
                this.debug('Calling Google Vision API');
                const base64Image = imageData.split(',')[1];
                
                const requestBody = {
                    requests: [{
                        image: { content: base64Image },
                        features: [{ type: 'TEXT_DETECTION', maxResults: 1 }]
                    }]
                };

                this.debug('Sending request to Google Vision API');
                const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${this.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                this.debug(`API response status: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    this.debug(`API error response: ${errorText}`);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                this.debug('API response received');
                
                if (result.responses?.[0]?.error) {
                    throw new Error(`Vision API Error: ${result.responses[0].error.message}`);
                }
                
                if (result.responses?.[0]?.textAnnotations?.[0]) {
                    return result.responses[0].textAnnotations[0].description;
                } else {
                    throw new Error('No text detected in image');
                }
            }

            async processWithTesseract(imageData) {
                this.debug('Loading Tesseract');
                if (!window.Tesseract) {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js';
                    document.head.appendChild(script);
                    
                    await new Promise(resolve => {
                        script.onload = resolve;
                    });
                }

                this.debug('Running Tesseract OCR');
                const { data: { text } } = await Tesseract.recognize(imageData, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            this.showStatus(`üîç Processing with basic OCR... ${progress}%`, 'processing');
                        }
                    }
                });
                
                return text;
            }

            extractBookInfo(text) {
                this.debug('Extracting book information from text');
                const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 2);
                
                let title = '';
                let author = '';
                let publisher = '';
                
                // Enhanced extraction with better logic for children's books
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    const lowerLine = line.toLowerCase();
                    
                    // Skip very short lines or lines with mostly symbols
                    if (line.length < 3 || /^[^a-zA-Z0-9\s]+$/.test(line)) continue;
                    
                    // Skip common non-content words
                    if (/\b(come on|the|a|an|and|or|but|in|on|at|to|for|of|with|by)\b$/i.test(line)) continue;
                    
                    // Look for author patterns (more specific)
                    if (!author) {
                        // Direct "by [Name]" pattern
                        if (/^by\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)$/i.test(line)) {
                            author = line.replace(/^by\s+/i, '').trim();
                            continue;
                        }
                        
                        // "words and pictures by [Name]" pattern (common in children's books)
                        if (/(?:words and pictures|story and pictures|written and illustrated)\s+by\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)/i.test(line)) {
                            const match = line.match(/by\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)/i);
                            if (match) {
                                author = match[1].trim();
                                continue;
                            }
                        }
                        
                        // Stand-alone proper name (likely author) - must be 2+ words, proper case
                        if (/^[A-Z][a-z]+\s+[A-Z][a-z]+(\s+[A-Z][a-z]+)*$/.test(line) && 
                            !lowerLine.includes('school') && 
                            !lowerLine.includes('go to') &&
                            !lowerLine.includes('has to')) {
                            author = line;
                            continue;
                        }
                    }
                    
                    // Look for publisher patterns
                    if (!publisher && (/\b(press|books|publishing|publishers?|publications?|media|house)\b/i.test(line))) {
                        publisher = line;
                        continue;
                    }
                    
                    // Title identification - prioritize longer, meaningful phrases
                    if (!title) {
                        // Must be substantial (5+ chars), not too long (under 80 chars)
                        // Should look like a title (not random words)
                        if (line.length >= 5 && line.length < 80 && 
                            !/\b(isbn|copyright|edition|page|chapter|come on)\b/i.test(line) &&
                            !/^(has to|the pigeon)$/i.test(line)) { // Exclude partial text
                            
                            // Prefer lines with title-like characteristics:
                            // - Multiple words
                            // - Contains articles/prepositions (the, to, has, etc.)
                            // - Sentence case or title case
                            const wordCount = line.split(/\s+/).length;
                            if (wordCount >= 3 || /\b(the|a|an|to|has|is|and|or|of|in|on|at|for)\b/i.test(line)) {
                                title = line;
                            }
                        }
                    }
                }
                
                // Post-processing: try to construct better title from multiple lines
                if (!title || title.length < 10) {
                    // Look for title patterns across multiple lines
                    for (let i = 0; i < lines.length - 1; i++) {
                        const combined = (lines[i] + ' ' + lines[i + 1]).trim();
                        if (combined.length > 10 && combined.length < 100 &&
                            !/\b(by|words and pictures|isbn|copyright)\b/i.test(combined)) {
                            
                            // Check if this looks more like a title
                            const wordCount = combined.split(/\s+/).length;
                            if (wordCount >= 4) {
                                title = combined;
                                break;
                            }
                        }
                    }
                }
                
                // Clean up and validate results
                if (title && author && title.toLowerCase() === author.toLowerCase()) {
                    // If title and author are the same, something went wrong
                    author = '';
                }
                
                // For your specific example: "The Pigeon HAS to GO to School!"
                if (!title && lines.length > 0) {
                    // Try to find the most title-like line
                    const titleCandidates = lines.filter(line => 
                        line.length > 8 && 
                        /[A-Z]/.test(line) && 
                        !/^(by|words and pictures)/i.test(line)
                    );
                    
                    if (titleCandidates.length > 0) {
                        title = titleCandidates[0];
                    }
                }
                
                return { 
                    title: title || '', 
                    author: author || '', 
                    publisher: publisher || '' 
                };
            }

            showExtractedData(bookData) {
                this.debug('Showing extracted data form');
                document.getElementById('bookTitle').value = bookData.title;
                document.getElementById('bookAuthor').value = bookData.author;
                document.getElementById('bookPublisher').value = bookData.publisher;
                
                // Auto-fill teacher from the saved default
                const defaultTeacher = document.getElementById('defaultTeacher').value.trim();
                document.getElementById('bookTeacher').value = defaultTeacher;
                
                document.getElementById('extractedData').classList.remove('hidden');
            }

            addBook() {
                const scannerName = document.getElementById('scannerName').value.trim();
                const title = document.getElementById('bookTitle').value.trim();
                const author = document.getElementById('bookAuthor').value.trim();
                const publisher = document.getElementById('bookPublisher').value.trim();
                const teacher = document.getElementById('bookTeacher').value.trim();
                
                if (!title || !author || !teacher) {
                    this.showStatus('Please fill in all required fields: Title, Author, and Teacher.', 'error');
                    return;
                }
                
                const book = {
                    id: Date.now(),
                    title,
                    author,
                    publisher: publisher || '',
                    scannedBy: scannerName,
                    teacher,
                    timestamp: new Date().toLocaleString()
                };
                
                this.debug(`Adding book: ${JSON.stringify(book)}`);
                
                this.books.unshift(book);
                this.saveBooks();
                this.updateDisplay();
                
                if (this.googleFormUrl) {
                    this.submitToGoogleSheets(book);
                }
                
                this.showStatus(`‚úÖ "${title}" added to the list!`, 'success');
                this.resetForNewScan();
            }

            async submitToGoogleSheets(book) {
                try {
                    this.debug('Submitting to Google Sheets');
                    
                    const formData = new FormData();
                    
                    formData.append('entry.1965693902', book.title);
                    formData.append('entry.1045781044', book.author);
                    formData.append('entry.1166974658', book.publisher);
                    formData.append('entry.1887797709', book.scannedBy);
                    formData.append('entry.1983576950', book.teacher);
                    
                    const response = await fetch(this.googleFormUrl, {
                        method: 'POST',
                        body: formData,
                        mode: 'no-cors'
                    });
                    
                    this.debug('Successfully submitted to Google Sheets');
                    
                } catch (error) {
                    this.debug('Error submitting to Google Sheets: ' + error.message);
                }
            }

            resetForNewScan() {
                this.debug('Resetting for new scan');
                document.getElementById('extractedData').classList.add('hidden');
                document.getElementById('photoPreview').classList.add('hidden');
                document.getElementById('bookTitle').value = '';
                document.getElementById('bookAuthor').value = '';
                document.getElementById('bookPublisher').value = '';
                document.getElementById('bookTeacher').value = '';
                document.getElementById('status').classList.add('hidden');
                document.getElementById('photoUpload').value = '';
            }

            updateDisplay() {
                this.debug(`Updating display with ${this.books.length} books`);
                const bookList = document.getElementById('bookList');
                const totalBooks = document.getElementById('totalBooks');
                const totalScanners = document.getElementById('totalScanners');
                
                totalBooks.textContent = this.books.length;
                
                const uniqueScanners = new Set(this.books.map(book => book.scannedBy));
                totalScanners.textContent = uniqueScanners.size;
                
                if (this.books.length === 0) {
                    bookList.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No books scanned yet. Start scanning to populate the list!</p>';
                } else {
                    bookList.innerHTML = this.books.map(book => `
                        <div class="book-item">
                            <h3>${this.escapeHtml(book.title)}</h3>
                            <p><strong>Author:</strong> ${this.escapeHtml(book.author)}</p>
                            <p><strong>Publisher:</strong> ${this.escapeHtml(book.publisher || 'Not specified')}</p>
                            <p><strong>Teacher:</strong> ${this.escapeHtml(book.teacher)}</p>
                            <p class="scanned-by">Scanned by ${this.escapeHtml(book.scannedBy)} on ${book.timestamp}</p>
                        </div>
                    `).join('');
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showStatus(message, type) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${type}`;
                status.classList.remove('hidden');
                
                if (type === 'success') {
                    setTimeout(() => status.classList.add('hidden'), 3000);
                }
            }

            loadBooks() {
                try {
                    const books = JSON.parse(localStorage.getItem('scannedBooks') || '[]');
                    this.debug(`Loaded ${books.length} books from storage`);
                    return books;
                } catch {
                    return [];
                }
            }

            saveBooks() {
                localStorage.setItem('scannedBooks', JSON.stringify(this.books));
                this.debug(`Saved ${this.books.length} books to storage`);
            }
        }

        const bookScanner = new BookScanner();

        if (window.location.search.includes('debug=true')) {
            console.log('Debug mode enabled - check the debug info section');
        }
    </script>
</body>
</html>
